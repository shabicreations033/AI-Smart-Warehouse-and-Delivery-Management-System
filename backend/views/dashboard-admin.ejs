<%- include('partials/header') %>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<%- include('partials/navbar') %>

<div id="chart-data-provider" data-chart='<%- chartDataJSON %>' style="display: none;"></div>

<main>
  <h2>Admin Control Panel</h2>

  <%- include('partials/_notifications') %>

  <div class="stats-grid">
    <div class="card stat-card"><h3>Total Users</h3><p><%= stats.users %></p></div>
    <div class="card stat-card"><h3>Warehouse Items</h3><p><%= stats.items %></p></div>
    <div class="card stat-card"><h3>Total Deliveries</h3><p><%= stats.deliveries %></p></div>
    <div class="card stat-card"><h3>Pending Deliveries</h3><p><%= stats.pending %></p></div>
  </div>
  
  <div class="dashboard" style="margin-top: 40px; grid-template-columns: 2fr 1fr;">
    <div class="card">
      <h3>Today's Deliveries (By Hour)</h3>
      <canvas id="deliveryChart"></canvas>
      <div id="deliveryChartError" class="feedback-box info-box" style="display: none; margin-top: 20px;"></div>
    </div>
    <div class="card">
      <h3>Stock Distribution</h3>
      <div style="max-width: 320px; margin: auto;">
        <canvas id="stockChart"></canvas>
      </div>
      <div id="stockChartError" class="feedback-box info-box" style="display: none; margin-top: 20px;"></div>
    </div>
  </div>

  <div class="dashboard" style="margin-top: 40px;">
    <div class="card">
      <h3>System Management</h3>
      <div class="card-actions">
        <a href="/users/manage" class="btn btn-primary">Manage Users</a>
        <a href="/inventory" class="btn btn-success">Manage Inventory</a>
      </div>
    </div>
    <div class="card">
      <h3>Operations Hub</h3>
      <div class="hub-actions">
        <a href="/manager-dashboard">Track Deliveries</a>
        <a href="/delivery-reports">Delivery Reports</a>
        <a href="/view-messages" class="btn btn-secondary">View Contact Messages</a>
      </div>
    </div>
  </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    try {
        const dataProvider = document.getElementById('chart-data-provider');
        if (!dataProvider) throw new Error("Data provider not found");
        
        const chartData = JSON.parse(dataProvider.dataset.chart);
        if (!chartData) throw new Error("Chart data is null or undefined");

        Chart.defaults.font.family = 'Inter';
        Chart.defaults.color = '#333745';
        
        const deliveryCtx = document.getElementById('deliveryChart');
        if (deliveryCtx && chartData.deliveryLabels) {
            if (chartData.deliveryValues.some(v => v > 0)) {
                new Chart(deliveryCtx, {
                    type: 'bar',
                    data: { 
                        labels: chartData.deliveryLabels, 
                        datasets: [{ 
                            label: '# of Deliveries', 
                            data: chartData.deliveryValues, 
                            backgroundColor: '#6a6c38',
                            borderColor: '#5a5c28',
                            hoverBackgroundColor: '#5a5c28',
                            borderWidth: 1, 
                            borderRadius: 4 
                        }] 
                    },
                    options: { 
                        scales: { 
                            y: { 
                                beginAtZero: true, 
                                ticks: { stepSize: 1 } 
                            } 
                        } 
                    }
                });
            } else {
                deliveryCtx.style.display = 'none';
                document.getElementById('deliveryChartError').style.display = 'block';
                document.getElementById('deliveryChartError').innerText = 'No deliveries have been made today.';
            }
        }

        const stockCanvas = document.getElementById('stockChart');
        if (stockCanvas && chartData.stockLabels && chartData.stockLabels.length > 0) {
            const stockCtx = stockCanvas.getContext('2d');
            const colorPalette = ['#6a6c38', '#2c3a2f', '#f6f4e1', '#d19c5d', '#c07c40'];

            new Chart(stockCtx, {
                type: 'doughnut',
                data: {
                    labels: chartData.stockLabels,
                    datasets: [{
                        label: 'Total Quantity',
                        data: chartData.stockValues,
                        backgroundColor: colorPalette,
                        hoverOffset: 12
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                padding: 15,
                                boxWidth: 15,
                            }
                        }
                    },
                    cutout: '60%', 
                    elements: {
                        arc: {
                            borderWidth: 0,
                            bevelWidth: 5,
                            bevelHighlightColor: 'rgba(255, 255, 255, 0.4)',
                            bevelShadowColor: 'rgba(0, 0, 0, 0.25)'
                        }
                    }
                }
            });
        
        } else if(stockCanvas) {
            stockCanvas.parentElement.style.display = 'none';
            document.getElementById('stockChartError').style.display = 'block';
            document.getElementById('stockChartError').innerText = 'No stock data available.';
        }
    } catch (e) {
        console.error("A critical error occurred while rendering the charts:", e);
    }
});
</script>

<%- include('partials/footer') %>